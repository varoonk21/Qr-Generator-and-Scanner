<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Scanner</title>
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.legacy.min.js"></script>
  <style>
    video {
      width: 100%;
      max-width: 500px;
      border: 2px solid #000;
      border-radius: 10px;
    }
    #controls {
      margin-top: 1rem;
    }
    select, button, input[type="file"] {
      margin: 5px;
      padding: 8px 12px;
      font-size: 16px;
    }
    #result {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
    .qr-scanner-overlay .scan-region-highlight {
      outline: 3px dashed white !important;
      border-radius: 8px;
      transition: outline 0.3s ease;
    }
    svg.scan-region-highlight-svg {
      stroke: white !important;
      stroke-width: 4;
      fill: none;
      transition: stroke 0.3s ease;
    }
    svg.scan-region-highlight-svg.success {
      stroke: limegreen !important;
    }
  </style>
</head>
<body>

  <h2>QR Code Scanner</h2>

  <video id="video" muted playsinline></video>

  <div id="controls">
    <select id="camera-select"></select>
    <button id="toggle-scan-btn">Start Scanning</button>
    <button id="toggle-flash-btn">Toggle Flashlight</button>
    <input type="file" id="image-input" accept="image/*">
  </div>

  <div id="result">Result: <span id="scan-result">None</span></div>

  <script>
  const video = document.getElementById('video');
  const cameraSelect = document.getElementById('camera-select');
  const toggleScanBtn = document.getElementById('toggle-scan-btn');
  const imageInput = document.getElementById('image-input');
  const resultEl = document.getElementById('scan-result');
  const toggleFlashBtn = document.getElementById('toggle-flash-btn');


  let qrScanner = new QrScanner(video, result => {
    resultEl.textContent = result.data || result;
    const svg = qrScanner.$overlay?.querySelector('svg.scan-region-highlight-svg');
            if (svg) {
              svg.classList.add('success');
              setTimeout(() => svg.classList.remove('success'), 2000);
            }
  }, 
  { returnDetailedScanResult: true,
        highlightScanRegion: true
   
      });

  let scanning = false;

    // Load and list cameras
    async function loadCameras() {
      const cameras = await QrScanner.listCameras(true);
      cameraSelect.innerHTML = '';
      cameras.forEach(camera => {
        const option = document.createElement('option');
        option.value = camera.id;
        option.text = camera.label || `Camera ${cameraSelect.length + 1}`;
        cameraSelect.appendChild(option);
      });
    }

    // Handle camera change
    cameraSelect.addEventListener('change', async () => {
      const selectedCamera = cameraSelect.value;
      if (scanning) {
        await qrScanner.setCamera(selectedCamera);
      }
    });

    // Toggle scanning
    toggleScanBtn.addEventListener('click', async () => {
      if (scanning) {
        qrScanner.stop();
        scanning = false;
        toggleScanBtn.textContent = 'Start Scanning';
      } else {
        await qrScanner.start();
        toggleFlashBtn.textContent = 'Turn Flashlight On';
        await qrScanner.setCamera(cameraSelect.value);
        scanning = true;
        toggleScanBtn.textContent = 'Stop Scanning';
      }
    });

    // Image file upload handler
    
      imageInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      const result = await QrScanner.scanImage(file, { returnDetailedScanResult: true })
        .catch(err => {
          resultEl.textContent = "❌ Failed to scan image.";
          console.error(err);
        });

      if (result?.data) {
        resultEl.textContent = `🖼️ Image Scan: ${result.data}`;
      }
    });

    //flash light
    toggleFlashBtn.addEventListener('click', async () => {
    if (!qrScanner) return;

    try {
      const hasFlash = await qrScanner.hasFlash();
      if (!hasFlash) {
        alert("Flashlight not supported on this camera.");
        return;
      }

      const isOn = qrScanner.isFlashOn();
      if (isOn) {
        await qrScanner.turnFlashOff();
        toggleFlashBtn.textContent = 'Turn Flashlight On';
      } else {
        await qrScanner.turnFlashOn();
        toggleFlashBtn.textContent = 'Turn Flashlight Off';
      }
    } catch (error) {
      console.error('Flashlight error:', error);
      alert("Failed to toggle flashlight.");
    }
  });
    // Init
    loadCameras();
  </script>

</body>
</html>
